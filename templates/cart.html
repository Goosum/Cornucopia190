<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        .cart-container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }

        .cart-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .cart-items-card {
            flex: 2;
        }

        .summary-card {
            flex: 1;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .cart-item img {
            max-width: 100px;
            height: auto;
            margin-right: 15px;
        }

        .cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cart-item-details p {
            margin: 0;
            font-size: 16px;
        }

        .cart-item-price {
            min-width: 100px;
            text-align: right;
        }

        .totals {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
            padding-top: 40px;
            border-top: 1px solid #ddd;
        }

        .totals p {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }

        .coupon-section form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .coupon-section input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .coupon-section button {
            padding: 10px 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .coupon-section button:hover {
            background-color: #45a049;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            gap: 10px;
        }
        
        .buttons a {
            flex: 1;
            margin: 0;
            padding: 7px 7px;
            background-color: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            white-space: normal;
        }
        
        .buttons a:hover {
            background-color: #45a049;
        }

        .flash-message {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .flash-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .flash-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .navbar {
            background-color: #4a5b2a;
        }

        .navbar .nav-link {
            color: #ffffff !important;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-sm sticky-top rounded m-3" style="background-color: #4a5b2a;">
        <div class="container-xxl d-flex align-items-center">
            <div class="logo-container d-flex align-items-center">
                <a href="{{ url_for('home') }}">
                    <img src="{{ url_for('static', filename='corn.png') }}" alt="Cornucopia Logo" 
                         style="width: 65px; height: 65px; margin-right: 10px;">
                </a>
                <span class="navbar-text text-light" style="font-size: 24px; font-weight: bold; margin-right: 20px;">
                    Cornucopia
                </span>
            </div>
    
            <div class="navbar-nav">
                <a class="nav-link text-light" href="{{ url_for('home') }}">Home</a>
                <a class="nav-link text-light" href="{{ url_for('cart') }}">Cart</a>
            </div>
    
            <form class="d-flex ms-auto search-container" role="search">
                <input class="form-control me-2" type="search" placeholder="Search" id="search-input">
                <button class="btn btn-dark" type="submit">Search</button>
            </form>
    
            <a href="{{ url_for('profile') }}" class="ms-3 text-light">
                <i class="fas fa-user"></i> Welcome, {{ username }}
            </a>
            <a href="{{ url_for('cart') }}" class="ms-3 text-light">
                <i class="fas fa-shopping-cart"></i> ðŸ›’ (<span id="cart-counter">{{ session.get('cart_total', 0) }}</span>)
            </a>
        </div>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div>
            {% for category, message in messages %}
            <div class="flash-message {{ category }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <h1>My Cart</h1>

    {% if cart %}
    <div class="cart-container">
        <div class="cart-card cart-items-card">
            <h2>Items in Your Cart</h2>
            <ul style="list-style-type: none; padding: 0;">
                {% for item in cart %}
                <li class="cart-item">
                    <img class="product-image" src="{{ item.image }}" alt="{{ item.name }}" 
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default.jpg') }}';">
                    <div class="cart-item-details">
                        <p>{{ item.name }}</p>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="quantity-{{ item.id }}" style="margin-right: 10px;">Quantity:</label>
                            <input 
                                type="number" 
                                id="quantity-{{ item.id }}" 
                                class="quantity-input" 
                                name="quantity" 
                                value="{{ item.quantity }}" 
                                min="1" 
                                data-product-id="{{ item.id }}"
                                style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center;">
                            <button 
                                class="delete-button" 
                                data-product-id="{{ item.id }}"
                                style="padding: 5px 10px; background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Delete
                            </button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        <p>${{ "%.2f" | format(item.price * item.quantity) }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    
        <div class="cart-card summary-card">
            <h2>Order Summary</h2>
            <div class="totals">
                <p>Subtotal: <span id="subtotal">${{ "%.2f" | format(subtotal) }}</span></p>
                <p>Tax (8.63%): <span id="tax">${{ "%.2f" | format(tax) }}</span></p>
                <p>Total: <span id="total">${{ "%.2f" | format(total) }}</span></p>
            </div>

            <div class="coupon-section" style="margin-top: 20px;">
                <form method="post" style="display: flex; gap: 10px; align-items: center;">
                    <label for="coupon" style="font-size: 16px; font-weight: bold;">Coupon Code:</label>
                    <input 
                        type="text" 
                        id="coupon" 
                        name="coupon" 
                        placeholder="Enter your coupon" 
                        style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px;">
                    <button type="submit" style="padding: 10px; background-color: #4caf50; color: white; border: none; border-radius: 10px; cursor: pointer;">
                        Apply
                    </button>
                    <button type="button" style="padding: 10px; background-color: red; color: white; border: none; border-radius: 10px; cursor: pointer;">
                        Remove
                    </button>
                </form>
            </div>

            <div class="buttons">
                <a href="{{ url_for('home') }}">Continue Shopping</a>
                <a href="{{ url_for('clear_cart') }}">Clear Cart</a>
                <a href="{{ url_for('checkout') }}">Proceed to Checkout</a>
            </div>
        </div>
    </div>
    {% else %}
        <p>Your cart is empty.</p>
        <a href="{{ url_for('home') }}">Back to Home</a>
    {% endif %}


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', async (event) => {
                    const productId = event.target.getAttribute('data-product-id');
                    const newQuantity = event.target.value;
    
                    try {
                        const response = await fetch(`/update_quantity/${productId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ quantity: newQuantity }),
                        });
    
                        if (response.ok) {
                            const data = await response.json();
                            updateCart(data, event.target.closest('.cart-item'), productId);
                        } else {
                            alert('Error updating quantity.');
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                    }
                });
            });
    
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const productId = event.target.getAttribute('data-product-id');
    
                    try {
                        const response = await fetch(`/delete_item/${productId}`, {
                            method: 'POST',
                        });
    
                        if (response.ok) {
                            const data = await response.json();
                            const cartItem = event.target.closest('.cart-item');
                            if (cartItem) cartItem.remove();
                            updateCart(data);
                        } else {
                            alert('Error deleting item.');
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                    }
                });
            });
    
            function updateCart(data, cartItem = null, productId = null) {
                document.querySelector('#subtotal').textContent = `$${data.subtotal.toFixed(2)}`;
                document.querySelector('#tax').textContent = `$${data.tax.toFixed(2)}`;
                document.querySelector('#total').textContent = `$${data.total.toFixed(2)}`;
    
                if (cartItem && productId && data.itemPrices) {
                    const itemPriceElement = cartItem.querySelector('.cart-item-price p');
                    itemPriceElement.textContent = `$${data.itemPrices[productId].toFixed(2)}`;
                }
            }
        });
    </script>
</body>
</html>