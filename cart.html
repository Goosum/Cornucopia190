<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function updateTotal(itemId, price) {
            const quantityInput = document.getElementById(`quantity_${itemId}`);
            const totalElement = document.getElementById(`total_${itemId}`);
            const newTotal = (quantityInput.value * price).toFixed(2);
            totalElement.textContent = newTotal;
            updateSubtotal();
        }

        function updateSubtotal() {
            let subtotal = 0;
            let totalItems = 0;
            document.querySelectorAll('.item-total').forEach(totalElement => {
                subtotal += parseFloat(totalElement.textContent);
            });
            document.querySelectorAll('input[type="number"]').forEach(quantityInput => {
                totalItems += parseInt(quantityInput.value) || 0;
            });

            const tax = (subtotal * 0.0863).toFixed(2);
            const total = (subtotal + parseFloat(tax)).toFixed(2);

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax').textContent = tax;
            document.getElementById('total').textContent = total;
            document.getElementById('total_items').textContent = totalItems;
        }
    </script>
</head>
<body>
    <h1>My Cart</h1>

    {% if cart %}
        <!-- Form for updating quantities -->
        <form action="{{ url_for('update_quantity') }}" method="POST">
            <ul style="list-style-type: none; padding: 0;">
                {% for item in cart %}
                <li style="padding: 10px 0; border-bottom: 1px solid #ddd; display: flex; align-items: flex-start;">
                    <!-- Container for product name and quantity -->
                    <div style="flex: 1;">
                        <!-- Product name -->
                        <div>{{ item.name }}</div>
                        
                        <!-- Quantity input below product name -->
                        <div style="margin-top: 5px;">
                            <label for="quantity_{{ item.id }}">Quantity:</label>
                            <input type="number" name="quantity_{{ item.id }}" id="quantity_{{ item.id }}" value="{{ item.quantity }}" min="1" style="width: 60px; text-align: center;" oninput="updateTotal({{ item.id }}, {{ item.price }})">
                        </div>
                    </div>

                    <!-- Total price aligned to the far right -->
                    <div style="text-align: right; margin-left: auto;">
                        <div style="font-weight: bold;">
                            $<span id="total_{{ item.id }}" class="item-total">{{ "%.2f" | format(item.price * item.quantity) }}</span>
                        </div>
                        
                        <!-- Remove button below the total price -->
                        <form action="{{ url_for('remove_item') }}" method="POST" style="margin-top: 5px;">
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <button type="submit" style="background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">Remove Item</button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>

            <!-- Summary section -->
            <div style="padding-top: 10px; border-top: 2px solid black; display: flex; justify-content: space-between; align-items: flex-start;">
                <!-- Total items on the left, aligned with subtotal -->
                <div style="display: flex; align-items: center;">
                    <p>Total Items: <span id="total_items">{{ cart | sum(attribute="quantity") }}</span></p>
                </div>
                
                <!-- Subtotal, Tax, and Total on the right -->
                <div style="text-align: right;">
                    <p>Subtotal: $<span id="subtotal">{{ "%.2f" | format(subtotal) }}</span></p>
                    <p>Tax (8.63%): $<span id="tax">{{ "%.2f" | format(tax) }}</span></p>
                    <p>Total: $<span id="total">{{ "%.2f" | format(total) }}</span></p>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <a href="{{ url_for('home') }}">Continue Shopping</a>
                <a href="{{ url_for('clear_cart') }}">Clear Cart</a>
            </div>
        </form>
    {% else %}
        <p>Your cart is empty.</p>
        <a href="{{ url_for('home') }}">Back to Home</a>
    {% endif %}
</body>
</html>